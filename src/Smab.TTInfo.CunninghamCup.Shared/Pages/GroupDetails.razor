@page "/group"
@page "/group/{GroupName}"
@using Smab.TTInfo.CunninghamCup.Shared.Services
@inject ITournamentService _tournamentService
@inject NavigationManager NavigationManager
@rendermode InteractiveServer


<PageTitle>Group Details</PageTitle>
<h1>@tournament?.Name</h1>


@if (tournament?.Groups.Count > 0)
{
	<div class="mb-3">
		<label for="groupSelector" class="form-label">Select Group:</label>
		<select id="groupSelector" class="form-select" @onchange="OnGroupChanged" value="@GroupName">
			@if (GroupName is null)
			{
				<option value=" " selected>Select a group</option>
			}
			@foreach (Group g in tournament.Groups)
			{
				<option value="@g.Name" selected="@(g.Name == GroupName)">@g.Name</option>
			}
		</select>
	</div>
}
@if (tournament?.Groups.Count == 0) {
	<h3>No Groups Available</h3>
	<p>Groups have not been drawn yet.</p>
} else if (group is null || players is null) {
	<p>Group or player data not loaded.</p>
} else {
	<div class="group-header">
		<h2>@group.Name</h2>
		<span class="badge bg-info">Round Robin</span>
		<span class="badge bg-secondary">Size @group.Players.Count</span>
		<button class="btn btn-sm btn-warning float-end" @onclick="ResetGroup">Reset</button>
		<button class="btn btn-sm btn-warning float-end mx-3" @onclick="CompleteWithRandomScores">Random scores</button>
	</div>

	<h3>Summary</h3>
	<table class="table table-dark table-striped">
		<thead>
			<tr>
				<th>#</th>
				<th>Player</th>
				<th>PL</th>
				<th>M</th>
				<th>S</th>
				<th>GM</th>
				<th>History</th>
			</tr>
		</thead>
		<tbody>
			@foreach ((int i, GroupPlayerSummary summary) in group.GroupPositions.Index()) {
				Player player = players.ContainsKey(summary.PlayerId) ? players[summary.PlayerId] : new Player(summary.PlayerId, "Unknown");
				<tr>
					<td>@(i + 1)</td>
					<td>@player.Name (@player.Handicap)</td>
					<td>@summary.Played</td>
					<td>@summary.MatchWins-@summary.MatchLosses</td>
					<td>@summary.SetsFor-@summary.SetsAgainst</td>
					<td>@summary.PointsFor-@summary.PointsAgainst</td>
					<td>
						@foreach (Match match in group.Matches.Where(m => summary.PlayerId == m.PlayerA || summary.PlayerId == m.PlayerB)) {
							@if (match.IsCompleted) {
								@if (match.PlayerA == summary.PlayerId) {
									@if (match.IsPlayerAWin) {
										<span class="badge bg-success rounded-pill">W</span>
									} else {
										<span class="badge bg-danger rounded-pill">L</span>
									}
								} 
								@if (match.PlayerB == summary.PlayerId) {
									@if (match.IsPlayerBWin) {
										<span class="badge bg-success rounded-pill">W</span>
									} else {
										<span class="badge bg-danger rounded-pill">L</span>
									}
								} 
							}
						}
					</td>
				</tr>
			}
		</tbody>
	</table>

	<h3>Matches</h3>
	<table class="table table-dark table-bordered">
		<thead>
			<tr>
				<th>#</th>
				<th>Player A</th>
				<th>Player B</th>
				<th>Sets</th>
				<th>Score</th>
				<th>Edit</th>
			</tr>
		</thead>
		<tbody>
			@for (int i = 0; i < group.Matches.Count; i++) {
				int matchNo = i;
				Match match = group.Matches[i];
				Player playerA = players.ContainsKey(match.PlayerA) ? players[match.PlayerA] : new Player(match.PlayerA, "Unknown");
				Player playerB = players.ContainsKey(match.PlayerB) ? players[match.PlayerB] : new Player(match.PlayerB, "Unknown");
				string score = match.Result is not null
				? $"{string.Join(", ", match.Result.Sets.Select(set => $"{set.PlayerAScore}-{set.PlayerBScore}"))}"
				: "";
				<tr>
					<td>@(i + 1)</td>
					<td>@playerA.Name (@match.PlayerAStart)</td>
					<td>@playerB.Name (@match.PlayerBStart)</td>
					<td>@($"{match.PlayerASets}-{match.PlayerBSets}")</td>
					<td>@score</td>
					@* <td>@(match.ScheduledTime?.ToString("ddd dd/MM/yyyy HH:mm") ?? "-")</td> *@
					@* <td>@(match.Notes ?? "-")</td> *@
					<td>
						<button class="btn btn-primary btn-sm" @onclick="() => EditMatch(match)">Edit</button>
						<button class="btn btn-sm btn-warning float-end" @onclick="() => CompleteMatchWithRandomScores(matchNo)">Random</button>
					</td>
				</tr>
			}
		</tbody>
	</table>
}

@code {
	[Parameter] public string GroupName { get; set; } = string.Empty;

	private Group? group;
	private Dictionary<PlayerId, Player>? players;
	private Tournament? tournament;

	protected override void OnInitialized()
	{
		tournament ??= _tournamentService.GetTournament();
		group = tournament.Groups.FirstOrDefault(g => string.Equals(g.Name, GroupName, StringComparison.OrdinalIgnoreCase));
		players = tournament.Players;
	}


	private void OnGroupChanged(ChangeEventArgs e)
	{
		string selectedGroup = e.Value?.ToString() ?? string.Empty;
		if (!string.Equals(selectedGroup, GroupName, StringComparison.OrdinalIgnoreCase))
		{
			// Navigate to the selected group page
			NavigationManager.NavigateTo($"/group/{selectedGroup}");
		}
	}

	private void CompleteWithRandomScores()
	{
		group = _tournamentService.CompleteGroupWithRandomResults(group!.Name);
	}

	private void CompleteMatchWithRandomScores(int matchNo)
	{
		group = _tournamentService.CompleteMatchWithRandomScores(group!.Name, matchNo);
	}

	private void ResetGroup()
	{
		group = _tournamentService.ResetGroup(group!.Name);
	}
}

@code {
	private void EditMatch(Match match)
	{
		// TODO: Show match editor dialog/modal
	}
}
